angular.module("iotapp",["ionic","chart.js"]).factory("globals",function(a){var b={};return b.rooturl="http://localhost:3000",b.loadingShow=function(){a.show({content:"Loading...",animation:"fade-in",showBackdrop:!0,maxWidth:200,template:'<ion-spinner icon="ios"></ion-spinner>',showDelay:0})},b.LoadingHide=function(){a.hide()},b}).factory("WatsonIoT",function(){return IBMIoTF.IotfApplication}).factory("backend",function(a){var b={};return b.get=function(b,c){a.get(b).success(function(a){c&&c(a)}).error(function(a){console.log("ERROR in getting path",b),c&&c(a)})},b}).factory("dbs",function(a){var b={};return b.get=function(b,c){a.get("/device/"+b,{params:{key1:"value1",key2:"value2"}}).success(function(a){console.log("SUCCESS DB "+b+"!",a),c&&c(a)}).error(function(a){console.log("ERROR in getting db",b),c&&c(a)})},b}).factory("iot",function(a,b){var c={},d=a,e="a-qc7qlc-7x4vfeo0i6",f="VIDMNZUlj6mzm(QyQ6";c.APIKey=e,c.AuthToken=f,c.OrgId="qc7qlc",c.EventLog="",c.connectionstatus="disconnected";var g=null;return c.connect=function(a){c.connectionstatus="connecting....",console.log("connecting to iot"),c.EventLog="",g=new d({org:c.OrgId,id:Date.now()+"",domain:"Â©","auth-key":c.APIKey,"auth-token":c.AuthToken}),g.connect(),g.on("error",function(a){console.log(a)}),g.on("connect",function(){console.log("iot onconnect"),c.connectionstatus="CONNECTED",g.subscribeToDeviceEvents(),b.$broadcast("iotConnected"),a&&a()}),window.onbeforeunload=function(){g.disconnect()},g.on("deviceEvent",function(a,d,e,f,g){c.EventLog="Device Event from :: "+a+" : "+d+" of event "+e+" with payload : "+g+"\n"+c.EventLog;var h=JSON.parse(g),i={deviceType:a,deviceId:d,eventType:e,format:f,payload:h};b.$broadcast("iotDeviceEvent",i)})},c}).factory("socket",function(a,b){var c={socket:{}};return c.socket=io.connect(a.rooturl),c.socket.on("getclientspecs",function(a){console.log("socket getclientspecs from the server",a)}),c.socket.on("iot_deviceevent",function(a){b.$broadcast("iotbuffer",a)}),c.socket.on("dashdata",function(a){b.$broadcast("dashdata",a)}),c}).factory("ChartService",function(){var a={};return a.defaultoptions={legend:{display:!0,position:"bottom",fullWidth:!0,labels:{fontSize:10,usePointStyle:!0}},showAllTooltips:!1,tooltipTemplate:"<%= value %>",tooltips:{backgroundColor:"rgba(0,0,0,1)",displayColors:!0,bodyFontColor:"rgba(255,255,255,0.8)",mode:"label",intersect:!1,pointHitDetectionRadius:"1",position:"average"},scaleShowLabels:!0,showScale:!0},Chart.pluginService.register({beforeRender:function(a){a.config.options.showAllTooltips&&(a.pluginTooltips=[],a.config.data.datasets.forEach(function(b,c){a.getDatasetMeta(c).data.forEach(function(b,c){a.pluginTooltips.push(new Chart.Tooltip({_chart:a.chart,_chartInstance:a,_data:a.data,_options:a.options.tooltips,_active:[b]},a))})}),a.options.tooltips.enabled=!1)},afterUpdate:function(a){if(a.config.options.elements.center){var b=Chart.helpers,c=a.config.options.elements.center,d=Chart.defaults.global,e=a.chart.ctx,f=b.getValueOrDefault(c.fontStyle,d.defaultFontStyle),g=b.getValueOrDefault(c.fontFamily,d.defaultFontFamily);if(c.fontSize)var h=c.fontSize;else{e.save();for(var h=b.getValueOrDefault(c.minFontSize,1),i=b.getValueOrDefault(c.maxFontSize,256),j=b.getValueOrDefault(c.maxText,c.text);;){e.font=b.fontString(h,f,g);var k=e.measureText(j).width;if(!(k<2*a.innerRadius&&h<i)){h-=1;break}h+=1}e.restore()}a.center={font:b.fontString(h,f,g),fillStyle:b.getValueOrDefault(c.fontColor,d.defaultFontColor)}}},afterDraw:function(a,b){if(a.config.options.showAllTooltips){if(!a.allTooltipsOnce){if(1!==b)return;a.allTooltipsOnce=!0}a.options.tooltips.enabled=!0,Chart.helpers.each(a.pluginTooltips,function(a){a.initialize(),a.update(),a.pivot(),a.transition(b).draw()}),a.options.tooltips.enabled=!1}if(a.center){var c=a.config.options.elements.center,d=a.chart.ctx;d.save(),d.font=a.center.font,d.fillStyle=a.center.fillStyle,d.textAlign="center",d.textBaseline="middle";var e=(a.chartArea.left+a.chartArea.right)/2,f=(a.chartArea.top+a.chartArea.bottom)/2;d.fillText(c.text,e,f),d.restore()}}}),a.chartSquareOptions={animation:!0,animationSteps:20,animationEasing:"easeOutQuart",showScale:!0,scaleOverride:!1,scaleSteps:null,scaleStepWidth:null,scaleStartValue:null,scaleLineColor:"rgba(0,0,0,.1)",scaleLineWidth:1,scaleShowLabels:!1,scaleLabel:"<%=value%>",sscaleLabel:"",scaleIntegersOnly:!0,scaleBeginAtZero:!1,scaleFontFamily:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",scaleFontSize:10,scaleFontStyle:"normal",scaleFontColor:"#666",responsive:!0,maintainAspectRatio:!0,showTooltips:!0,tooltipEvents:["mousemove","touchstart","touchmove"],tooltipFillColor:"rgba(0,0,0,0.8)",tooltipFontFamily:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",tooltipFontSize:14,tooltipFontStyle:"normal",tooltipFontColor:"#fff",tooltipTitleFontFamily:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",tooltipTitleFontSize:14,tooltipTitleFontStyle:"bold",tooltipTitleFontColor:"#fff",tooltipYPadding:6,tooltipXPadding:6,tooltipCaretSize:8,tooltipCornerRadius:6,tooltipXOffset:10,tooltipTemplate:"<%if (label){%><%=label%>: <%}%><%= value %>",multiTooltipTemplate:"<%= value %>",showAllTooltips:!0,onAnimationProgress:function(){},onAnimationComplete:function(){}},a.chartRoundOptions={animation:!0,animationSteps:20,animationEasing:"easeOutQuart",showScale:!0,scaleOverride:!1,scaleSteps:null,scaleStepWidth:null,scaleStartValue:null,scaleLineColor:"rgba(0,0,0,.1)",scaleLineWidth:1,scaleShowLabels:!1,scaleLabel:"<%=value%>",sscaleLabel:"",scaleIntegersOnly:!0,scaleBeginAtZero:!1,scaleFontFamily:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",scaleFontSize:10,scaleFontStyle:"normal",scaleFontColor:"#666",responsive:!0,maintainAspectRatio:!0,showTooltips:!0,tooltipEvents:["mousemove","touchstart","touchmove"],tooltipFillColor:"rgba(0,0,0,0.8)",tooltipFontFamily:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",tooltipFontSize:14,tooltipFontStyle:"normal",tooltipFontColor:"#fff",tooltipTitleFontFamily:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",tooltipTitleFontSize:14,tooltipTitleFontStyle:"bold",tooltipTitleFontColor:"#fff",tooltipYPadding:6,tooltipXPadding:6,tooltipCaretSize:8,tooltipCornerRadius:6,tooltipXOffset:10,tooltipTemplate:"<%if (label){%><%=label%>: <%}%><%= value %>",multiTooltipTemplate:"<%= value %>",showAllTooltips:!0,onAnimationProgress:function(){},onAnimationComplete:function(){}},a.pie=function(b){return b||(b={labels:["Download Sales","In-Store Sales","Mail-Order Sales"],data:[300,500,100],options:a.chartRoundOptions}),b},a.radar=function(b){return b||(b={labels:["Download Sales","In-Store Sales","Mail-Order Sales"],data:[300,500,100],options:a.chartRoundOptions}),b},a.bubble=function(b){return b||(b={labels:["Download Sales","In-Store Sales","Mail-Order Sales"],data:[{x:300,y:500,z:100}],options:a.chartRoundOptions}),b},a.doughnot=function(a){return a||(a={labels:["Download Sales","In-Store Sales","Mail-Order Sales"],data:[30,50,20]}),a},a.line=function(b){return b||(b={labels:["January","February","March","April","May","June","July"],series:["Average Spent Effort","Average Estimated Effort","Average Remainning Effort"],sdata:[[65,59,80,81,56,55,40],[28,48,40,19,86,27,90],[18,38,40,49,81,43,77]],data:[[],[],[]],options:a.chartSquareOptions}),b},a.bars=function(b){return b||(b={labels:["2006","2007","2008","2009","2010","2011","2012"],series:["Packer","Maker"],data:[[65,59,80,81,56,55,40],[28,48,40,19,86,27,90]],options:a.chartSquareOptions}),b},a}).config(function(a,b){a.state("app",{url:"/app",abstract:!0,cache:!1,templateUrl:"menu.html",controller:"AppCtrl"}).state("app.home",{url:"/home",cache:!1,views:{menuContent:{templateUrl:"templates/home.html",controller:"HomeCtrl"}}}).state("app.dash",{url:"/dash",views:{menuContent:{templateUrl:"templates/dashboard.html",controller:"DashCtrl"}}}).state("app.chart",{url:"/chart",views:{menuContent:{templateUrl:"templates/chart.html",controller:"ChartCtrl"}}}),b.otherwise("/app/home")}).controller("AppCtrl",function(a,b,c){a.attendees=[{firstname:"Nicolas",lastname:"Cage"},{firstname:"Jean-Claude",lastname:"Van Damme"},{firstname:"Keanu",lastname:"Reeves"},{firstname:"Steven",lastname:"Seagal"}],a.toggleLeft=function(){c.toggleLeft()}}).controller("MainCtrl",function(a,b){a.attendees=[{firstname:"Nicolas",lastname:"Cage"},{firstname:"Jean-Claude",lastname:"Van Damme"},{firstname:"Keanu",lastname:"Reeves"},{firstname:"Steven",lastname:"Seagal"}],a.toggleLeft=function(){b.toggleLeft()}}).controller("CheckinCtrl",function(a){a.showForm=!0,a.shirtSizes=[{text:"Large",value:"L"},{text:"Medium",value:"M"},{text:"Small",value:"S"}],a.attendee={},a.submit=function(){return a.attendee.firstname?(a.showForm=!1,void a.attendees.push(a.attendee)):void alert("Info required")}}).controller("AttendeesCtrl",function(a){a.activity=[],a.arrivedChange=function(b){var c=b.firstname+" "+b.lastname;c+=b.arrived?" just left, ":" has arrived, ",c+=(new Date).getMilliseconds(),a.activity.push(c),a.activity.length>3&&a.activity.splice(0,1)}}).controller("sHomeCtrl",function(a,b,c){var d=b,e="a-qc7qlc-7x4vfeo0i6",f="VIDMNZUlj6mzm(QyQ6";a.main={},a.main.APIKey=e,a.main.AuthToken=f,a.main.OrgId="qc7qlc",a.main.EventLog="",a.main.connectionstatus="disconnected";var g=null;a.main.connect=function(){a.main.connectionstatus="connecting....",console.log("connecting to iot"),a.main.EventLog="",g=new d({org:a.main.OrgId,id:Date.now()+"",domain:"internetofthings.ibmcloud.com","auth-key":a.main.APIKey,"auth-token":a.main.AuthToken}),g.connect(),g.on("connect",function(){console.log("iot onconnect"),a.main.connectionstatus="CONNECTED",a.$digest(),g.subscribeToDeviceEvents(),c.go("app.dash")}),window.onbeforeunload=function(){g.disconnect()},g.on("deviceEvent",function(b,c,d,e,f){a.main.EventLog="Device Event from :: "+b+" : "+c+" of event "+d+" with payload : "+f+"\n"+a.main.EventLog,a.$digest();var g=JSON.parse(f);console.log(g)})}}).controller("HomeCtrl",function(a,b,c){a.main={EventLog:b.EventLog},a.iotconnect=function(){console.log("connecting"),b.connect(function(){console.log("connected to iot !!"),c.go("app.dash")})}}).controller("DashCtrl",function(a,b,c,d,e,f,g,h){var i=e;b.selectedMachine="121P",b.linecampo="True_duration",b.line2campo="acceleration_x",b.eventlog=[],b.eventlog2=[],b.linedata=[[0,0,0,0,0,0,0,0,0,0]],b.linelabels=[1,2,3,4,5,6,7,8,9,10],b.phases=companydescr,b.prodoutput=100,b.totoutput=800,b.dohnutdata=[65,59,80,81,56,55,40],b.pie=i.pie();for(var j=[],k=[],l=0;l<50;l++)j.push(0),k.push("");b.bubble={},b.bubble.series=[],b.bubble.options={scales:{xAxes:[{display:!1,ticks:{max:125,min:-125,stepSize:10}}],yAxes:[{display:!1,ticks:{max:125,min:-125,stepSize:10}}]}};b.healthyscoretrends={data:[[1,2,3,4,5,20]],series:[["MUZIO"]],labels:[["January","February","March","April","May","June","July"]]},b.healthyscoretrends.options={showTooltips:!0,responsive:!0},b.radar=i.radar({labels:[],series:[],data:[[10,11,80,81,56,55,40]]}),b.doughnot=i.doughnot({labels:["a","b"],data:[85,15]}),b.doughnot.options={sanimation:{onComplete:function(){console.log("animation complete");var a=this,b=this.chart,c=b.ctx;c.font="25px Arial",c.textAlign="center",c.fillStyle="#000000",Chart.helpers.each(a.data.datasets.forEach(function(b,d){var i,j,k,e=a.getDatasetMeta(d),f=0,g=[],h=Math.PI/2,l=0;for(var m in b.data)f+=m;Chart.helpers.each(e.data.forEach(function(a,c){i=.9*a._model.outerRadius-a._model.innerRadius,j=a._model.x,k=a._model.y;var d=b.data[c],e=Math.PI*(2*d/f);a.hasValue()&&b.data[c]>0?g.push(l+e/2+Math.PI+h):g.push(-1),l+=e}),a);var n=3*i/4;for(var o in g)if(g[o]!==-1){var p=g[o],q=j+n*Math.cos(p),r=k+n*Math.sin(p),m=Math.round(b.data[o]/f*100);c.fillText(m+"%",q,r)}}),a)}},elements:{center:{maxText:"100%",text:"70%",fontColor:"#36A2EB",fontFamily:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",fontStyle:"normal",minFontSize:1,maxFontSize:256}}},b.line=i.line({labels:[],series:[],data:[[10,11,80,81,56,55,40]]}),b.line2=i.line({labels:k,series:[],data:[j]}),b.bars=i.bars(),b.defectbar=i.bars({labels:["2010","2011","2012","2013","2014"],series:["Packer","Maker"],data:[[10,45],[10,45]]}),b.defectbar.options={responsive:!0,scales:{xAxes:[{stacked:!1,barThickness:80}],yAxes:[{stacked:!0}]}},b.piedata=[65,59,80,81,56,55,40],b.polardata=[65,59,80,81,56,55,40],b.colors=["#45b7cd","#ff6384","#ff8e72"],b.numevents=0,b.buffersize=10,b.buffersteps=1,b.buffercount=0,b.buffer=[],b.simulstatus=!1,b.init=function(){c.connect(),console.log("dounot",b.doughnot.data),g.get("/simulation/getsimulstatus",function(c){a(function(){b.simulstatus=c.simulstatus,console.log(b.simulstatus)})})},b.selectMachine=function(a){b.selectedMachine=a,console.log("machine",a),"121P"==a&&(b.linecampo="True_duration",b.line2campo="acceleration_x"),"H1000"==a&&(b.linecampo="True_duration",b.line2campo="acceleration_y"),"W1000BV"==a&&(b.linecampo="True_duration",b.line2campo="acceleration_z")},b.getOperationShutdownTime=function(){g.get("/dashboard/operationshutdowntime",function(a){console.log("operationshutdowntime",a);b.lineoptions={legend:{display:!1}};var d=i.defaultoptions,e=parseInt(a.production/a.total*100.1),f=parseInt(a.stop/a.total*100,10),g=parseInt(a.wait/a.total*100);b.pie2=i.pie({labels:["Production","Stop","Wait"],series:["Production","Stop","Wait"],data:[e,f,g],options:d})})},b.getProductionOutputWithTarget=function(){g.get("/dashboard/productionoutputwithtarget",function(a){console.log("productionooutpuwithtarget",a),b.prodoutput=a.paker1})},b.getProductionDefectCount=function(){g.get("/dashboard/productdefectcount",function(a){console.log("productdefectcount",a),b.defectbar=i.bars({labels:[""],series:["Packer","Maker"],data:[[a.paker],[a.maker]]})})},b.getEquipmentAnomalyCount=function(){g.get("/dashboard/equipmentanomalycount",function(a){console.log("equipmentanomalycount",a),b.equipmentanomaly=i.bars({labels:[""],series:["Maker"],data:[[a.maker]]})})},b.getDeviceData=function(){f.loadingShow(),d.get("andro1212",function(a){console.log("got andro1212",a),a.rows.forEach(function(a,c){if(c<100){var d=a.doc;"121212"==d.deviceId&&(6==b.line.data[0].length&&b.line.data[0].shift(),b.line.data[0].push(d.payload.d.acceleration_x))}}),f.LoadingHide()})},b.$on("iotDeviceEvent",function(a,c){return}),b.$on("iotbuffer",function(c,d){var e=d.events;console.log("iot events received from socket server",c,d);var h=0;e.forEach(function(a,c){h++,b.line2.data[0].shift(),b.line2.data[0].push(a);var d="acceleration_x: "+a;b.eventlog2.length>=20&&b.eventlog2.shift(),b.eventlog2.push(d)}),a(function(){})}),b.$on("dashdata",function(c,d){var e=d.operation,f=d.data,g=d.simulation_index;if("operationshutdowntime"==e){b.lineoptions={legend:{display:!1}};var j=i.defaultoptions,k=parseInt(f.production/f.total*100.1),l=parseInt(f.stop/f.total*100,10),m=parseInt(f.wait/f.total*100);a(function(){b.pie2=i.pie({labels:["Production","Stop","Wait"],series:["Production","Stop","Wait"],data:[k,l,m],options:j})})}if("productionoutputwithtarget"==e&&a(function(){b.prodoutput=f.paker1}),"productdefectcount"==e&&a(function(){b.defectbar=i.bars({labels:[""],series:["Packer","Maker"],data:[[f.paker],[f.maker]]})}),"equipmentanomalycount"==e&&a(function(){b.equipmentanomaly=i.bars({labels:[""],series:["Maker"],data:[[f.maker]]})}),"filesimulation"==e){if(console.log("simulindex",g,"data",f),0==g){var n="True_duration",o=f[n];b.linedata[0].shift(),b.lineseries=n,b.eventlog.length>=20&&b.eventlog.shift(),b.eventlog.push(n+" - "+o),b.linedata[0].push(o)}if(1==g){var n="Paker_64",o=f[n];b.line2.data[0].shift(),b.line2.series=n,b.eventlog2.length>=20&&b.eventlog2.shift(),b.eventlog2.push(n+" - "+o),b.line2.data[0].push(o)}b.$digest()}}),b.toggleCsvSimulation=function(){g.get("/simulation/setsimul/toggle",function(a){console.log(a),b.simulstatus=a.simulstatus,console.log(b.simulstatus);var c="ON";0==b.simulstatus&&(c="OFF"),h.show({template:"CSV simulation has been turned "+c,noBackdrop:!0,duration:2e3})})}});